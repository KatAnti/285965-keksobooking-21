(()=>{"use strict";(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),n=document.querySelector(".ad-form"),o=document.querySelector(".map__pin--main"),a=document.querySelector(".map__filters");window.constants={escape:"Escape",maxAdsAmount:5,filtersFormElement:a,mapElement:e,pinsContainerElement:t,adFormElement:n,startPinElement:o}})(),(()=>{const e=(e,t)=>{const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(()=>{200===n.status?e(n.response):t("Произошла ошибка! Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+"мc")})),n.timeout=1e4,n};window.backend={load:(t,n)=>{const o=e(t,n);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},send:(t,n,o)=>{const a=e(n,o);a.open("POST","https://21.javascript.pages.academy/keksobooking"),a.send(t)}}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e=document.querySelector("#housing-type"),t=document.querySelector("#housing-price"),n=document.querySelector("#housing-rooms"),o=document.querySelector("#housing-guests"),a=document.querySelectorAll(".map__checkbox");let r={onSelectChange:()=>{},onInputChange:()=>{}};window.constants.filtersFormElement.addEventListener("change",(e=>{e.target&&e.target.matches("select")&&r.onSelectChange(),e.target&&e.target.matches("input")&&r.onInputChange()})),window.filter={setSelectChangeHandler:e=>{r.onSelectChange=e},setInputChangeHandler:e=>{r.onInputChange=e},start:r=>{const s=(()=>{let e=0;return window.constants.filtersFormElement.querySelectorAll("select").forEach((t=>{"any"!==t.value&&(e+=1)})),window.constants.filtersFormElement.querySelectorAll("input").forEach((t=>{t.checked&&(e+=1)})),e})(),i=r.filter((r=>(r=>{let s=0;return r.offer.type===e.value&&(s+=1),(e=>{let t;switch(!0){case e<1e4:t="low";break;case e>5e4:t="high";break;default:t="middle"}return t})(r.offer.price)===t.value&&(s+=1),String(r.offer.rooms)===n.value&&(s+=1),String(r.offer.guests)===o.value&&(s+=1),a.forEach((e=>{e.checked&&r.offer.features.includes(e.value)&&(s+=1)})),s})(r)===s));((e,t)=>{window.map.closeCard(),window.map.createPins(e,t)})(i,i.length>window.constants.maxAdsAmount?window.constants.maxAdsAmount:i.length)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={render:t=>{const n=e.cloneNode(!0);return n.style.left=t.location.x-25+"px",n.style.top=t.location.y-70+"px",n.querySelector("img").src=t.author.avatar,n.querySelector("img").alt=t.offer.title,n.querySelector("img").style.pointerEvents="none",n.dataset.id=t.index,n}}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector("#card").content.querySelector(".map__card");window.card={render:n=>{const o=t.cloneNode(!0);var a,r,s,i;return o.querySelector(".popup__avatar").src=n.author.avatar,o.querySelector(".popup__title").textContent=n.offer.title,o.querySelector(".popup__text--address").textContent=n.offer.address,o.querySelector(".popup__text--price").innerHTML=n.offer.price+"&#x20bd;<span>/ночь</span>",o.querySelector(".popup__type").textContent=e[n.offer.type],o.querySelector(".popup__text--capacity").textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,o.querySelector(".popup__text--time").textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`,a=o.querySelectorAll(".popup__feature"),r=n.offer.features,a.forEach((e=>{let t=!1;r.forEach((n=>{e.className.includes("--"+n)&&(t=!0)})),t||e.classList.add("hidden")})),o.querySelector(".popup__description").textContent=n.offer.description,s=n.offer.photos,i=o.querySelector(".popup__photos"),s.forEach(((e,t)=>{const n=i.querySelector("img");if(0===t)n.src=e;else{const t=n.cloneNode();t.src=e,i.append(t)}})),((e,t)=>{Object.keys(e).forEach((n=>{Object.keys(e[n]).forEach((o=>{e[n][o]&&0!==e[n][o].length&&0!==parseInt(e[n][o],10)||((e,t)=>{let n=e;"checkin"===n||"checkout"===n?n="time":"rooms"!==n&&"guests"!==n||(n="capacity"),(t.querySelector(".popup__"+n)?t.querySelector(".popup__"+n):t.querySelector(".popup__text--"+n)).classList.add("hidden")})(o,t)}))}))})(n,o),o}}})(),(()=>{const e=window.constants.pinsContainerElement.offsetWidth-31,t=document.querySelector("#address"),n=document.querySelector(".map__filters-container"),o=(e,n,o)=>{e=o?e+31:e+32.5,n=o?n+82:n+32.5,t.value=`${Math.round(e)}, ${Math.round(n)}`},a=(e,t)=>{e&&(window.constants.startPinElement.style.left=e+"px"),t&&(window.constants.startPinElement.style.top=t+"px")},r={x:()=>window.constants.startPinElement.offsetLeft,y:()=>window.constants.startPinElement.offsetTop},s=e=>{e.key===window.constants.escape&&(e.preventDefault(),i())},i=()=>{const e=window.constants.mapElement.querySelector(".popup");e&&e.remove(),document.removeEventListener("keypress",s)},c=()=>{i()};window.map={setInputAdress:o,setMainPinCoords:a,activateMainPin:()=>{const t=n=>{a(r.x()+n.movementX,r.y()+n.movementY);const s=(e,n,o)=>{let s="x"===e?{x:n,y:!1}:{x:!1,y:n};(o?r[e]()<n:r[e]()>n)&&(window.constants.pinsContainerElement.removeEventListener("mousemove",t),a(s.x,s.y))};s("x",-31,!0),s("x",e,!1),s("y",48,!0),s("y",548,!1),window.constants.pinsContainerElement.addEventListener("mouseleave",(()=>{window.constants.pinsContainerElement.removeEventListener("mousemove",t)})),o(r.x(),r.y(),!0)};window.constants.pinsContainerElement.addEventListener("mousemove",t),window.constants.pinsContainerElement.addEventListener("mouseup",(()=>{window.constants.pinsContainerElement.removeEventListener("mousemove",t),o(r.x(),r.y(),!0)}))},createPins:(e,t)=>{const n=document.createDocumentFragment();Array.from(window.constants.pinsContainerElement.children).forEach((e=>{e.matches(".map__overlay")||e.matches(".map__pin--main")||e.remove()}));for(let o=0;o<t;o++)n.append(window.pin.render(e[o],o));window.constants.pinsContainerElement.append(n)},openCard:(e,t)=>{n.before(window.card.render(e[t])),window.constants.mapElement.querySelector(".popup").querySelector(".popup__close").addEventListener("click",c),document.addEventListener("keydown",s)},closeCard:i}})(),(()=>{const e=document.querySelector("main"),t=window.constants.adFormElement.querySelector("#room_number"),n=window.constants.adFormElement.querySelector("#capacity"),o=window.constants.adFormElement.querySelector("#price"),a=window.constants.adFormElement.querySelector("#type"),r=window.constants.adFormElement.querySelector("#timein"),s=window.constants.adFormElement.querySelector("#timeout"),i=window.constants.adFormElement.querySelector("#title"),c=window.constants.adFormElement.querySelector(".ad-form__reset"),d=document.querySelector("#success").content.querySelector(".success"),l=document.querySelector("#error").content.querySelector(".error"),m=()=>{n.querySelectorAll("option").forEach((e=>{const n=t.value<e.value,o="100"===t.value,a="0"!==e.value;e.disabled=!1,e.selected=!0,(n&&!o||o&&a||!o&&!a)&&(e.disabled=!0,e.selected=!1)}))},u=()=>{switch(a.value){case"bungalow":o.min=0,o.placeholder="0";break;case"flat":o.min=1e3,o.placeholder="1000";break;case"house":o.min=5e3,o.placeholder="5000";break;case"palace":o.min=1e4,o.placeholder="10000"}},p=e=>{e.target&&e.target.matches("#timein")?s.value=e.target.value:r.value=e.target.value},w=e=>{e.key===window.constants.escape&&h(document.querySelector(".success"),w,f)},f=()=>{h(document.querySelector(".success"),w,f)},y=e=>{e.key===window.constants.escape&&h(document.querySelector(".error"),y,E)},E=()=>{h(document.querySelector(".error"),y,E)},v=(t,n,o)=>{const a=t.cloneNode(!0);e.appendChild(a),document.addEventListener("keydown",n),document.addEventListener("click",o)},h=(e,t,n)=>{e.remove(),document.removeEventListener("keydown",t),document.removeEventListener("click",n)},S=()=>{v(l,y,E)},g=()=>{window.page.disactivate(),v(d,w,f)};i.addEventListener("input",(()=>{i.value.length<30?i.setCustomValidity("Описание должно быть не короче 30 символов"):100===i.value.length?i.setCustomValidity("Вы достигли максимальной длины описания в 100 символов"):i.setCustomValidity(""),i.reportValidity()})),o.addEventListener("input",(()=>{parseInt(o.value,10)>1e6?o.setCustomValidity("Цена не может превышать 1000000"):o.setCustomValidity(""),o.reportValidity()})),t.addEventListener("click",(()=>{m()})),a.addEventListener("click",(()=>{u()})),r.addEventListener("click",(e=>{p(e)})),s.addEventListener("click",(e=>{p(e)})),window.constants.adFormElement.addEventListener("submit",(e=>{e.preventDefault(),window.backend.send(new FormData(window.constants.adFormElement),g,S)})),c.addEventListener("click",(e=>{e.preventDefault(),window.page.disactivate()})),window.form={setState:(e,t)=>{Array.from(e.children).forEach((e=>{e.disabled=t}))},checkCapacity:m,syncMinPrice:u}})(),(()=>{let e=[];const t=t=>{e=t.slice(),e.forEach(((e,t)=>{e.index=t})),window.form.setState(window.constants.filtersFormElement,!1),window.map.createPins(e,window.constants.maxAdsAmount),window.constants.pinsContainerElement.addEventListener("click",(t=>{t.target&&t.target.matches(".map__pin")&&!t.target.matches(".map__pin--main")&&(document.querySelectorAll(".map__pin").forEach((e=>{e.classList.remove("map__pin--active")})),window.map.closeCard(),window.map.openCard(e,t.target.dataset.id),t.target.classList.add("map__pin--active"))}))},n=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: rgba(255, 86, 53, 0.7);",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="20px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};window.page={activate:e=>{!window.constants.mapElement.classList.contains("map--faded")||0!==e.button&&e.key!==window.constants.escape||(window.constants.mapElement.classList.remove("map--faded"),window.constants.adFormElement.classList.remove("ad-form--disabled"),window.backend.load(t,n),window.form.setState(window.constants.adFormElement,!1))},disactivate:()=>{window.constants.adFormElement.reset(),window.constants.filtersFormElement.reset(),window.form.syncMinPrice(),window.constants.mapElement.classList.add("map--faded"),window.form.setState(window.constants.adFormElement,!0),window.constants.adFormElement.classList.add("ad-form--disabled"),window.map.closeCard(),window.map.setMainPinCoords(570,375),window.map.setInputAdress(window.constants.startPinElement.offsetLeft,window.constants.startPinElement.offsetTop,!1),Array.from(window.constants.pinsContainerElement.children).forEach((e=>{e.matches(".map__pin")&&!e.matches(".map__pin--main")&&e.remove()}))},getFilteredAds:()=>e}})(),window.form.setState(window.constants.adFormElement,!0),window.form.setState(window.constants.filtersFormElement,!0),window.map.setInputAdress(window.constants.startPinElement.offsetLeft,window.constants.startPinElement.offsetTop,!1),window.form.checkCapacity(),window.form.syncMinPrice(),window.constants.startPinElement.addEventListener("mousedown",(e=>{window.page.activate(e),window.map.setInputAdress(window.constants.startPinElement.offsetLeft,window.constants.startPinElement.offsetTop,!0),window.map.activateMainPin(),window.filter.setSelectChangeHandler(window.debounce((()=>{window.filter.start(window.page.getFilteredAds())}))),window.filter.setInputChangeHandler(window.debounce((()=>{window.filter.start(window.page.getFilteredAds())})))})),window.constants.startPinElement.addEventListener("keydown",(e=>{window.page.activate(e)})),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),n=document.querySelector(".ad-form-header__preview"),o=document.querySelector(".ad-form__upload input[type=file]"),a=document.querySelector(".ad-form__photo"),r=(t,n)=>{const o=t.files[0],a=o.name.toLowerCase();if(e.some((e=>a.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{n.querySelector("img")?n.querySelector("img").src=e.result:((e,t)=>{const n=document.createElement("img");n.src=e,n.width="70",n.height="70",n.alt="Фотография пользователя",t.append(n)})(e.result,n)})),e.readAsDataURL(o)}};t.addEventListener("change",(()=>{r(t,n)})),o.addEventListener("change",(()=>{r(o,a)}))})()})();