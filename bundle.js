(()=>{"use strict";(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),n=document.querySelector(".ad-form"),o=document.querySelector(".map__pin--main"),r=document.querySelector(".map__filters");window.constants={escape:"Escape",maxAdsAmount:5,filtersFormElement:r,mapElement:e,pinsContainerElement:t,adFormElement:n,startPinElement:o}})(),(()=>{const e=(e,t)=>{const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(()=>{200===n.status?e(n.response):t("Произошла ошибка! Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+"мc")})),n.timeout=1e4,n};window.backend={load:(t,n)=>{const o=e(t,n);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},send:(t,n,o)=>{const r=e(n,o);r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e=document.querySelector("#housing-type"),t=document.querySelector("#housing-price"),n=document.querySelector("#housing-rooms"),o=document.querySelector("#housing-guests"),r=document.querySelectorAll(".map__checkbox");let a={onSelectChange:()=>{},onInputChange:()=>{}};window.constants.filtersFormElement.addEventListener("change",(e=>{e.target&&e.target.matches("select")&&a.onSelectChange(),e.target&&e.target.matches("input")&&a.onInputChange()})),window.filter={setSelectChangeHandler:e=>{a.onSelectChange=e},setInputChangeHandler:e=>{a.onInputChange=e},start:a=>{const s=(()=>{let e=0;return window.constants.filtersFormElement.querySelectorAll("select").forEach((t=>{"any"!==t.value&&(e+=1)})),window.constants.filtersFormElement.querySelectorAll("input").forEach((t=>{t.checked&&(e+=1)})),e})(),i=a.filter((a=>(a=>{let s=0;return a.offer.type===e.value&&(s+=1),(e=>{let t;switch(!0){case e<1e4:t="low";break;case e>5e4:t="high";break;default:t="middle"}return t})(a.offer.price)===t.value&&(s+=1),String(a.offer.rooms)===n.value&&(s+=1),String(a.offer.guests)===o.value&&(s+=1),r.forEach((e=>{e.checked&&a.offer.features.includes(e.value)&&(s+=1)})),s})(a)===s));((e,t)=>{window.map.closeCard(),window.map.createPins(e,t)})(i,i.length>window.constants.maxAdsAmount?window.constants.maxAdsAmount:i.length)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={render:t=>{const n=e.cloneNode(!0);return n.style.left=t.location.x-25+"px",n.style.top=t.location.y-70+"px",n.querySelector("img").src=t.author.avatar,n.querySelector("img").alt=t.offer.title,n.querySelector("img").style.pointerEvents="none",n.dataset.id=t.index,n}}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector("#card").content.querySelector(".map__card");window.card={render:n=>{const o=t.cloneNode(!0);var r,a,s,i;return o.querySelector(".popup__avatar").src=n.author.avatar,o.querySelector(".popup__title").textContent=n.offer.title,o.querySelector(".popup__text--address").textContent=n.offer.address,o.querySelector(".popup__text--price").textContent=n.offer.price+"₽/ночь",o.querySelector(".popup__type").textContent=e[n.offer.type],o.querySelector(".popup__text--capacity").textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,o.querySelector(".popup__text--time").textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`,r=o.querySelectorAll(".popup__feature"),a=n.offer.features,r.forEach((e=>{let t=!1;a.forEach((n=>{e.className.includes("--"+n)&&(t=!0)})),t||e.classList.add("hidden")})),o.querySelector(".popup__description").textContent=n.offer.description,s=n.offer.photos,i=o.querySelector(".popup__photos"),s.forEach(((e,t)=>{const n=i.querySelector("img");if(0===t)n.src=e;else{const t=n.cloneNode();t.src=e,i.append(t)}})),((e,t)=>{Object.keys(e).forEach((n=>{Object.keys(e[n]).forEach((o=>{e[n][o]&&0!==e[n][o].length&&0!==parseInt(e[n][o],10)||((e,t)=>{let n=e;"checkin"===n||"checkout"===n?n="time":"rooms"!==n&&"guests"!==n||(n="capacity"),(t.querySelector(".popup__"+n)?t.querySelector(".popup__"+n):t.querySelector(".popup__text--"+n)).classList.add("hidden")})(o,t)}))}))})(n,o),o}}})(),(()=>{const e=window.constants.pinsContainerElement.offsetWidth-31,t=document.querySelector("#address"),n=document.querySelector(".map__filters-container"),o=(e,n,o)=>{e=o?e+31:e+32.5,n=o?n+82:n+32.5,t.value=`${Math.round(e)}, ${Math.round(n)}`},r=(e,t)=>{e&&(window.constants.startPinElement.style.left=e+"px"),t&&(window.constants.startPinElement.style.top=t+"px")},a={x:()=>window.constants.startPinElement.offsetLeft,y:()=>window.constants.startPinElement.offsetTop},s=e=>{e.key===window.constants.escape&&(e.preventDefault(),i())},i=()=>{const e=window.constants.mapElement.querySelector(".popup"),t=window.constants.mapElement.querySelector(".map__pin--active");e&&e.remove(),t&&(t.classList.remove("map__pin--active"),t.blur()),document.removeEventListener("keypress",s)},c=()=>{i()};window.map={setInputAdress:o,setMainPinCoords:r,activateMainPin:()=>{const t=n=>{r(a.x()+n.movementX,a.y()+n.movementY);const s=(e,n,o)=>{const s="x"===e?{x:n,y:!1}:{x:!1,y:n};(o?a[e]()<n:a[e]()>n)&&(window.constants.pinsContainerElement.removeEventListener("mousemove",t),r(s.x,s.y))};s("x",-31,!0),s("x",e,!1),s("y",48,!0),s("y",548,!1),window.constants.pinsContainerElement.addEventListener("mouseleave",(()=>{window.constants.pinsContainerElement.removeEventListener("mousemove",t)})),o(a.x(),a.y(),!0)};window.constants.pinsContainerElement.addEventListener("mousemove",t),window.constants.pinsContainerElement.addEventListener("mouseup",(()=>{window.constants.pinsContainerElement.removeEventListener("mousemove",t),o(a.x(),a.y(),!0)}))},createPins:(e,t)=>{const n=document.createDocumentFragment();Array.from(window.constants.pinsContainerElement.children).forEach((e=>{e.matches(".map__overlay")||e.matches(".map__pin--main")||e.remove()}));for(let o=0;o<t;o++)n.append(window.pin.render(e[o],o));window.constants.pinsContainerElement.append(n)},openCard:(e,t)=>{n.before(window.card.render(e[t])),window.constants.mapElement.querySelector(".popup").querySelector(".popup__close").addEventListener("click",c),document.addEventListener("keydown",s)},closeCard:i}})(),(()=>{const e={bungalow:0,flat:1e3,house:5e3,palace:1e4},t=document.querySelector("main"),n=window.constants.adFormElement.querySelector("#room_number"),o=window.constants.adFormElement.querySelector("#capacity"),r=window.constants.adFormElement.querySelector("#price"),a=window.constants.adFormElement.querySelector("#type"),s=window.constants.adFormElement.querySelector("#timein"),i=window.constants.adFormElement.querySelector("#timeout"),c=window.constants.adFormElement.querySelector("#title"),d=window.constants.adFormElement.querySelector(".ad-form__reset"),l=document.querySelector("#success").content.querySelector(".success"),m=document.querySelector("#error").content.querySelector(".error"),w=()=>{o.querySelectorAll("option").forEach((e=>{const t=n.value<e.value,o="100"===n.value,r="0"!==e.value;e.disabled=!1,e.selected=!0,(t&&!o||o&&r||!o&&!r)&&(e.disabled=!0,e.selected=!1)}))},u=()=>{r.min=e[a.value],r.placeholder=""+e[a.value]},p=e=>{e.target&&e.target.matches("#timein")?i.value=e.target.value:s.value=e.target.value},f=(e,n,o)=>{const r=e.cloneNode(!0);t.appendChild(r),document.addEventListener("keydown",n),document.addEventListener("click",o)},y=(e,t,n)=>{e.remove(),document.removeEventListener("keydown",t),document.removeEventListener("click",n)},E=e=>{const t=document.querySelector(".success"),n=document.querySelector(".error");e.key===window.constants.escape&&t?y(t,E,v):e.key===window.constants.escape&&n&&y(n,E,v)},v=()=>{const e=document.querySelector(".success"),t=document.querySelector(".error");e?y(e,E,v):t&&y(t,E,v)},g=()=>{f(m,E,v)},h=()=>{window.page.disactivate(),f(l,E,v)};c.addEventListener("input",(()=>{c.value.length<30?c.setCustomValidity("Описание должно быть не короче 30 символов"):100===c.value.length?c.setCustomValidity("Вы достигли максимальной длины описания в 100 символов"):c.setCustomValidity(""),c.reportValidity()})),r.addEventListener("input",(()=>{parseInt(r.value,10)>1e6?r.setCustomValidity("Цена не может превышать 1000000"):r.setCustomValidity(""),r.reportValidity()})),n.addEventListener("change",(()=>{w()})),a.addEventListener("change",(()=>{u()})),s.addEventListener("change",(e=>{p(e)})),i.addEventListener("change",(e=>{p(e)})),window.constants.adFormElement.addEventListener("submit",(e=>{e.preventDefault(),window.backend.send(new FormData(window.constants.adFormElement),h,g)})),d.addEventListener("click",(e=>{e.preventDefault(),window.page.disactivate()})),window.form={setState:(e,t)=>{Array.from(e.children).forEach((e=>{e.disabled=t}))},checkCapacity:w,syncMinPrice:u,clearUploaded:()=>{window.constants.adFormElement.querySelector(".ad-form-header__preview img").src="img/muffin-grey.svg",window.constants.adFormElement.querySelector(".ad-form__photo img")&&window.constants.adFormElement.querySelector(".ad-form__photo img").remove()}}})(),(()=>{let e=[];const t=t=>{e=t.slice(),e.forEach(((e,t)=>{e.index=t})),window.form.setState(window.constants.filtersFormElement,!1),window.map.createPins(e,window.constants.maxAdsAmount),window.constants.pinsContainerElement.addEventListener("click",(t=>{t.target&&t.target.matches(".map__pin")&&!t.target.matches(".map__pin--main")&&(window.map.closeCard(),window.map.openCard(e,t.target.dataset.id),t.target.classList.add("map__pin--active"),t.target.focus())}))},n=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: rgba(255, 86, 53, 0.7);",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="20px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};window.page={activate:e=>{!window.constants.mapElement.classList.contains("map--faded")||0!==e.button&&e.key!==window.constants.escape||(window.constants.mapElement.classList.remove("map--faded"),window.constants.adFormElement.classList.remove("ad-form--disabled"),window.backend.load(t,n),window.form.setState(window.constants.adFormElement,!1),window.form.setState(window.constants.filtersFormElement,!1))},disactivate:()=>{window.constants.adFormElement.reset(),window.constants.filtersFormElement.reset(),window.constants.mapElement.classList.add("map--faded"),window.constants.adFormElement.classList.add("ad-form--disabled"),window.form.setState(window.constants.adFormElement,true),window.form.setState(window.constants.filtersFormElement,true),window.form.clearUploaded(),window.form.syncMinPrice(),window.map.closeCard(),window.map.setMainPinCoords(570,375),window.map.setInputAdress(window.constants.startPinElement.offsetLeft,window.constants.startPinElement.offsetTop,!1),Array.from(window.constants.pinsContainerElement.children).forEach((e=>{e.matches(".map__pin")&&!e.matches(".map__pin--main")&&e.remove()}))},getFilteredAds:()=>e}})(),window.form.setState(window.constants.adFormElement,!0),window.form.setState(window.constants.filtersFormElement,!0),window.map.setInputAdress(window.constants.startPinElement.offsetLeft,window.constants.startPinElement.offsetTop,!1),window.form.checkCapacity(),window.form.syncMinPrice(),window.constants.startPinElement.addEventListener("mousedown",(e=>{window.page.activate(e),window.map.setInputAdress(window.constants.startPinElement.offsetLeft,window.constants.startPinElement.offsetTop,!0),window.map.activateMainPin(),window.filter.setSelectChangeHandler(window.debounce((()=>{window.filter.start(window.page.getFilteredAds())}))),window.filter.setInputChangeHandler(window.debounce((()=>{window.filter.start(window.page.getFilteredAds())})))})),window.constants.startPinElement.addEventListener("keydown",(e=>{window.page.activate(e)})),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),n=document.querySelector(".ad-form-header__preview"),o=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo"),a=(t,n)=>{const o=t.files[0],r=o.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{n.querySelector("img")?n.querySelector("img").src=e.result:((e,t)=>{const n=document.createElement("img");n.src=e,n.width="70",n.height="70",n.alt="Фотография пользователя",t.append(n)})(e.result,n)})),e.readAsDataURL(o)}};t.addEventListener("change",(()=>{a(t,n)})),o.addEventListener("change",(()=>{a(o,r)}))})()})();